name: Generate Blog Post

on:
  schedule:
    # 매일 한국시간 오전 9시 (UTC 0시) 실행
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 수동 실행도 가능
    inputs:
      category:
        description: '카테고리 (macro, realestate, corporate, global)'
        required: false
        default: ''
      count:
        description: '생성할 글 수'
        required: false
        default: '1'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Restore Blogger token
        run: |
          mkdir -p config/google
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > config/google/credentials.json
          echo '${{ secrets.BLOGGER_TOKEN_JSON }}' > config/google/token.json

      - name: Generate blog posts (2 per day, rotating categories)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
        run: |
          CATEGORY="${{ github.event.inputs.category }}"

          if [ -n "$CATEGORY" ]; then
            # 수동 실행: 지정된 카테고리만
            COUNT="${{ github.event.inputs.count || '1' }}"
            for i in $(seq 1 $COUNT); do
              echo "=== Generating $CATEGORY post $i/$COUNT ==="
              python -m blog_agents generate "$CATEGORY" --auto --draft
            done
          else
            # 자동 실행: 하루 2편, 요일별 로테이션
            # 월/수/금/일(1,3,5,0) → 거시경제 + 부동산
            # 화/목/토(2,4,6)     → 기업법 + 글로벌뉴스
            DOW=$(date -u +%u)  # 1=월 ~ 7=일

            if [ $((DOW % 2)) -eq 1 ]; then
              echo "=== [Day $DOW] 1/2: 거시경제·금융정책 ==="
              python -m blog_agents generate macro --auto --draft
              echo "=== [Day $DOW] 2/2: 부동산·세법 ==="
              python -m blog_agents generate realestate --auto --draft
            else
              echo "=== [Day $DOW] 1/2: 기업법·공정거래 ==="
              python -m blog_agents generate corporate --auto --draft
              echo "=== [Day $DOW] 2/2: 글로벌 뉴스 ==="
              python -m blog_agents generate global --auto --draft
            fi
          fi

      - name: Upload generated content
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blog-output-${{ github.run_number }}
          path: output/
          retention-days: 30
