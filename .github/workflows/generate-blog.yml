name: Generate Blog Post

on:
  schedule:
    # 매일 한국시간 오전 9시 (UTC 0시) 실행
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 수동 실행도 가능
    inputs:
      category:
        description: '카테고리 (macro, realestate, corporate)'
        required: false
        default: ''
      count:
        description: '생성할 글 수'
        required: false
        default: '1'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Restore Blogger token
        run: |
          mkdir -p config/google
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > config/google/credentials.json
          echo '${{ secrets.BLOGGER_TOKEN_JSON }}' > config/google/token.json

      - name: Generate blog posts (3 categories)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
        run: |
          CATEGORY="${{ github.event.inputs.category }}"

          if [ -n "$CATEGORY" ]; then
            # 수동 실행: 지정된 카테고리만
            COUNT="${{ github.event.inputs.count || '1' }}"
            for i in $(seq 1 $COUNT); do
              echo "=== Generating $CATEGORY post $i/$COUNT ==="
              python -m blog_agents generate --category "$CATEGORY" --auto --publish
            done
          else
            # 자동 실행: 3개 카테고리 각 1편씩
            echo "=== 1/3: 거시경제·금융정책 ==="
            python -m blog_agents generate --category macro --auto --publish

            echo "=== 2/3: 부동산·세법 ==="
            python -m blog_agents generate --category realestate --auto --publish

            echo "=== 3/3: 기업법·공정거래 ==="
            python -m blog_agents generate --category corporate --auto --publish
          fi

      - name: Upload generated content
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blog-output-${{ github.run_number }}
          path: output/
          retention-days: 30
